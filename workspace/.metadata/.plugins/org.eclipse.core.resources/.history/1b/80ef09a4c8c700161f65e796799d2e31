package org.ntua.tant.rest.DBService;


import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.ntua.tant.rest.model.Message;

public class DB {
		private Connection connection;
		private List<Message> messages = new ArrayList<>();
		private static String ConnectionURL = "jdbc:postgresql://localhost:5432/rest";
		private static String forNamePath = "org.postgresql.Driver";
		private static String username = "postgres";
		private static String password = "tant";
		
		public DB(){
			connection = this.connect();
			setMessages(this.selectAllMessages(connection));
		}
		
		public Connection connect() {
			Connection connection = null;
			try {
				Class.forName(forNamePath);
				connection = DriverManager.getConnection(ConnectionURL,username,password);
			} catch (Exception e) {
		        System.out.println(e.getMessage());
		        return null;
			}
			return connection;
		}
		
		public void disconnect() {
			
			try {
				this.connection.close();
			} catch (Exception e) {
		        System.err.println(e.getMessage()); 
			}
		}
		
		public List<Message> selectAllMessages(Connection connection){
		    Statement stmt = null;
			if (connection != null) {
				try {
					connection.setAutoCommit(false);
					stmt = connection.createStatement();
					List<Message> messages = new ArrayList<>();
			        ResultSet rs = stmt.executeQuery( "SELECT * FROM \"requests\"" );
			        while ( rs.next() ) {
			        	int id = rs.getInt("id");
			        	int userid = rs.getInt("userid");
			        	Date requestDate = rs.getDate("requestDate");
			        	int responseCode = rs.getInt("responseCode");
			        	String  responseMessage = rs.getString("responseMessage");
			            String  message = rs.getString("message");
			            Message messageRec = new Message(id, userid, requestDate,responseCode, responseMessage,message);
			            messages.add(messageRec);
			            messageRec.printMessage();
			         }
			         rs.close();
			         stmt.close();
			         disconnect();
			         return messages;
				} catch ( Exception e ) {
					 System.err.println( e.getMessage() );
					 return null;
			    }
			}
			return null;
		}
		
		public Connection getConnection() {
			return this.connection;
		}
		
		public void setConnection(Connection connection) {
			this.connection = connection;
		}

		public List<Message> getMessages() {
			return messages;
		}

		public void setMessages(List<Message> messages) {
			this.messages = messages;
		}
}
